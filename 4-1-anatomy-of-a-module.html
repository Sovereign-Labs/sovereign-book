<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Anatomy of a Module - The Sovereign SDK Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="/assets/sovereign-dark-highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="1-intro.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded "><a href="2-running-starter.html"><strong aria-hidden="true">2.</strong> Running the Starter Rollup</a></li><li class="chapter-item expanded "><a href="3-quickstart.html"><strong aria-hidden="true">3.</strong> Quickstart: Your First Module</a></li><li class="chapter-item expanded "><a href="4-0-build-for-production-intro.html"><strong aria-hidden="true">4.</strong> Building for Production</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="4-1-anatomy-of-a-module.html"><strong aria-hidden="true">4.1.</strong> Anatomy of a Module</a></li><li class="chapter-item expanded "><a href="4-2-testing-your-module.html"><strong aria-hidden="true">4.2.</strong> Testing Your Module</a></li><li class="chapter-item expanded "><a href="4-3-wallets-and-accounts.html"><strong aria-hidden="true">4.3.</strong> Wallets and Accounts</a></li><li class="chapter-item expanded "><a href="4-4-advanced-topics.html"><strong aria-hidden="true">4.4.</strong> Advanced Topics</a></li><li class="chapter-item expanded "><a href="4-5-performance.html"><strong aria-hidden="true">4.5.</strong> Performance</a></li><li class="chapter-item expanded "><a href="4-6-prebuilt-modules.html"><strong aria-hidden="true">4.6.</strong> Prebuilt Modules</a></li></ol></li><li class="chapter-item expanded "><a href="5-additional-capabilities.html"><strong aria-hidden="true">5.</strong> Additional Capabilities</a></li><li class="chapter-item expanded "><a href="6-0-intro.html"><strong aria-hidden="true">6.</strong> Instrumenting Your Rollup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="6-1-metrics.html"><strong aria-hidden="true">6.1.</strong> Metrics</a></li><li class="chapter-item expanded "><a href="6-2-logging.html"><strong aria-hidden="true">6.2.</strong> Logging</a></li></ol></li><li class="chapter-item expanded "><a href="7-0-intro.html"><strong aria-hidden="true">7.</strong> SDK Contributors</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="7-1-transaction-lifecycle.html"><strong aria-hidden="true">7.1.</strong> Transaction Lifecyle</a></li><li class="chapter-item expanded "><a href="7-2-abstractions.html"><strong aria-hidden="true">7.2.</strong> Main Abstractions</a></li><li class="chapter-item expanded "><a href="7-3-forced-sequencer-registration.html"><strong aria-hidden="true">7.3.</strong> Forced Sequencer Registration</a></li><li class="chapter-item expanded "><a href="7-4-gas.html"><strong aria-hidden="true">7.4.</strong> Gas</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="sovereign-dark">Sovereign Dark</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Sovereign SDK Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="anatomy-of-a-module"><a class="header" href="#anatomy-of-a-module">Anatomy of a Module</a></h1>
<p>As we begin our journey into building a production-ready module, the first step is to understand the two most important architectural concepts in the Sovereign SDK: the <strong>Runtime</strong> and its <strong>Modules</strong>.</p>
<h2 id="runtime-vs-modules"><a class="header" href="#runtime-vs-modules">Runtime vs. Modules</a></h2>
<p>The <strong>runtime</strong> is the orchestrator of your rollup. It receives transactions, deserializes them, and routes them to the appropriate modules for execution. Think of it as the central nervous system that connects all your application logic. The <a href="https://github.com/Sovereign-Labs/sov-rollup-starter-wip/blob/main/crates/stf/stf-declaration/src/lib.rs#L51"><code>Runtime</code></a> struct you define in your rollup code is what specifies which modules are included.</p>
<p><strong>Modules</strong>, on the other hand, contain the actual, isolated business-logic. Each module manages its own state and defines the specific actions (called "call messages") that users can perform.  In the quickstart, <code>ValueSetter</code> was your module.</p>
<p>Now that we understand this high-level structure, let's dissect the <code>ValueSetter</code> module you built and enhance it with production-grade features.</p>
<h2 id="dissecting-the-valuesetter-module"><a class="header" href="#dissecting-the-valuesetter-module">Dissecting the <code>ValueSetter</code> Module</a></h2>
<h4 id="the-module-struct-state-and-dependencies"><a class="header" href="#the-module-struct-state-and-dependencies">The Module Struct: State and Dependencies</a></h4>
<p>You started by defining the <code>ValueSetter</code> struct. This is the entry point to any module, defining its state variables and its dependencies on other modules.</p>
<pre><code class="language-rust">#[derive(Clone, ModuleInfo, ModuleRestApi)]
pub struct ValueSetter&lt;S: Spec&gt; {
    #[id]
    pub id: ModuleId,

    #[state]
    pub value: StateValue&lt;u32&gt;,

    #[state]
    pub admin: StateValue&lt;S::Address&gt;,
}</code></pre>
<p>This struct is defined by several key attributes and the <code>Spec</code> generic:</p>
<ul>
<li><code>#[derive(ModuleInfo)]</code>: This derive macro is mandatory. It performs essential setup, like laying out your state values in the database.</li>
<li><code>#[id]</code>: Every module must have exactly one field with this attribute. The SDK uses it to store the module's unique, auto-generated identifier.</li>
<li><code>#[state]</code>: This attribute marks a field as a state variable that will be stored in the database. More on <a href="#state-management-in-depth">state management</a> later.</li>
<li><strong>The</strong> <code>Spec</code> <strong>Generic</strong>: All modules are generic over a <code>Spec</code>. This provides core types like <code>S::Address</code> and makes your module portable across things like DA layers, zkVMs, and address formats.</li>
<li><code>#[module]</code>: While not used in this example, this attribute declares a dependency on another module. For example, if our <code>ValueSetter</code> needed to charge a fee, we could add <code>#[module] pub bank: sov_bank::Bank&lt;S&gt;</code>, allowing us to call methods like <code>self.bank.transfer(...)</code> from our own logic.</li>
</ul>
<h4 id="the-modulerestapi-trait"><a class="header" href="#the-modulerestapi-trait">The <code>ModuleRestApi</code> Trait</a></h4>
<p>Deriving the <code>ModuleRestApi</code> trait is optional but highly recommended. It automatically generates RESTful API endpoints for the <code>#[state]</code> items in your module. Each item's endpoint will have the name <code>{hostname}/modules/{module-name}/{field-name}/</code>, with all items automatically converted to <code>kebab-casing</code>. For example, for the <code>value</code> field in our <code>ValueSetter</code> module, the SDK generates an endpoint at the path <code>/modules/value-setter/value</code>.</p>
<p>Note that <code>ModuleRestApi</code> can't always generate endpoints for you. If it can't figure out how to generate an endpoint for a particular state value, it will simply skip it by default. If you want to override this behavior and throw a compiler error if endpoint generation fails, you can add the <code>#[rest_api(include)]</code> attribute.</p>
<h3 id="state-management-in-depth"><a class="header" href="#state-management-in-depth">State Management In-Depth</a></h3>
<p>The SDK provides several "state" types for different use cases, all designed to be stored within your module struct using the <code>#[state]</code> attribute.</p>
<ul>
<li><code>StateValue&lt;T&gt;</code>: Stores a single item of type <code>T</code>. We use this for the <code>value</code> and <code>admin</code> variables in our example.</li>
<li><code>StateMap&lt;K, V&gt;</code>: Stores a key-value mapping. Ideal for balances or other user-specific data.</li>
<li><code>StateVec&lt;T&gt;</code>: Stores an ordered list of items, accessible by index.</li>
</ul>
<p>The generic types can be any deterministic Rust data structure, anything from a simple <code>u32</code> to a complex <code>BTreeMap</code>.</p>
<p><strong>Accessory State</strong>: For each state type, there is a corresponding <code>AccessoryState*</code> variant (e.g., <code>AccessoryStateMap</code>). Accessory state is special: it can be read via the API, but it is <strong>write-only</strong> during a transaction. This makes it a simple and cheap storage to use for data that doesn't affect onchain logic, like purchase histories for an off-chain frontend.</p>
<h3 id="the-module-trait-understanding-your-logic"><a class="header" href="#the-module-trait-understanding-your-logic">The <code>Module</code> Trait: Understanding Your Logic</a></h3>
<p>The <code>Module</code> trait is where your business logic lives. Let's review the pieces you implemented for <code>ValueSetter</code> in the quickstart.</p>
<ul>
<li>
<p><strong><code>type Config</code> and <code>fn genesis()</code></strong>: You created a <code>ValueSetterConfig</code> and used it in the <code>genesis</code> method to initialize the <code>admin</code> state. This is a standard pattern: <code>Config</code> defines the initial data, read from <code>genesis.json</code>, and <code>genesis()</code> applies it to the module's state when the rollup is first deployed.</p>
</li>
<li>
<p><strong><code>type CallMessage</code> and <code>fn call()</code></strong>: You defined a <code>CallMessage</code> enum for the public <code>SetValue</code> action. This enum is the public API of your module, representing the actions a user can take. The <code>call()</code> method is the entry point for these actions. The runtime passes in the <code>CallMessage</code> and a <code>Context</code> containing metadata like the sender's address, which you used for the admin check.</p>
</li>
<li>
<p><strong>Error Handling</strong>: In your <code>call</code> method, you used <code>anyhow::ensure!</code> to handle a <strong>user error</strong> (an invalid sender). When a <code>call</code> method returns an <code>Err</code>, the SDK guarantees that all state changes are automatically reverted, ensuring atomicity. This <code>Result</code>-based approach is for predictable user errors, while unrecoverable system bugs should cause a <code>panic!</code>. A more detailed guide is available in the <a href="./4-4-advanced-topics.html"><code>Advanced Topics</code></a> section.</p>
</li>
</ul>
<blockquote>
<p><strong>A Quick Tip on Parametrizing Your Types Over S</strong></p>
<p>If you parameterize your <code>CallMessage</code> or <code>Event</code> over <code>S</code> (for example, to include an address of type <code>S::Address</code>), you must add the <code>#[schemars(bound = "S: Spec", rename = "MyEnum")]</code> attribute on top your enum definition. This is a necessary hint for <code>schemars</code>, a library that generates a JSON schema for your module's API. It ensures that your generic types can be correctly represented for external tools.</p>
</blockquote>
<h2 id="adding-events"><a class="header" href="#adding-events">Adding Events</a></h2>
<p>Your <code>ValueSetter</code> module works, but it's a "black box." Off-chain applications have no way of knowing when the value changes without constantly polling the API. To solve this, we introduce <strong>Events</strong>.</p>
<p>Events are the primary mechanism for streaming on-chain data to off-chain systems like indexers and front-ends in real-time. Let's add one to our module.</p>
<p>First, define an <code>Event</code> enum.</p>
<pre><code class="language-rust">// In examples/value-setter/src/lib.rs

#[derive(Clone, Debug, PartialEq, Eq, JsonSchema)]
#[serialize(Borsh, Serde)]
#[serde(rename_all = "snake_case")]
pub enum Event {
    ValueUpdated(u32),
}</code></pre>
<p>Next, update your <code>Module</code> implementation to use this new <code>Event</code> type and emit it from the <code>call</code> method.</p>
<pre><code class="language-rust">// In examples/value-setter/src/lib.rs

impl&lt;S: Spec&gt; Module for ValueSetter&lt;S&gt; {
    type Spec = S;
    type Config = ValueSetterConfig&lt;S&gt;;
    type CallMessage = CallMessage;
    type Event = Event; // Change this from ()

    // The `genesis` method is unchanged.
    fn genesis(&amp;mut self, _header: &amp;&lt;S::Da as sov_modules_api::DaSpec&gt;::BlockHeader, config: &amp;Self::Config, state: &amp;mut impl GenesisState&lt;S&gt;) -&gt; Result&lt;()&gt; {
        // ...
    }

    fn call(&amp;mut self, msg: Self::CallMessage, context: &amp;Context&lt;S&gt;, state: &amp;mut impl TxState&lt;S&gt;) -&gt; Result&lt;()&gt; {
        match msg {
            CallMessage::SetValue(new_value) =&gt; {
                let admin = self.admin.get(state)??;
                anyhow::ensure!(admin == *context.sender(), "Only the admin can set the value.");

                self.value.set(&amp;new_value, state)?;

                // NEW: Emit an event to record this change.
                self.emit_event(state, Event::ValueUpdated(new_value));

                Ok(())
            }
        }
    }
}</code></pre>
<p>Now, whenever the admin successfully calls <code>set_value</code>, the module will emit a <code>ValueUpdated</code> event.</p>
<p>A key guarantee of the Sovereign SDK is that event emission is <strong>atomic</strong> with transaction executionâ€”if a transaction reverts, so do its events. This ensures any off-chain system remains perfectly consistent with the on-chain state.</p>
<p>To make it simple to build scalable and faul-tolertant off-chain data pipelines, the sequencer provides a websocket endpoint that streams sequentially numbered transactions along with their corresponding events. If a client disconnects, it can reliably resume the stream from the last transaction it processed.</p>
<h2 id="next-step-ensuring-correctness"><a class="header" href="#next-step-ensuring-correctness">Next Step: Ensuring Correctness</a></h2>
<p>You now have a deep, conceptual understanding of how a Sovereign SDK module is structured.</p>
<p>In the next chapter, <strong>"Testing Your Module,"</strong> we'll show you how to test your modules.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="4-0-build-for-production-intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="4-2-testing-your-module.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="4-0-build-for-production-intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="4-2-testing-your-module.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
