<!DOCTYPE HTML>
<html lang="en" class="sovereign-dark" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Gas - The Sovereign SDK Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="..//assets/sovereign-dark-highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "sovereign-dark" : "sovereign-dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('sovereign-dark')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded "><a href="getting-started.html"><strong aria-hidden="true">2.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="rollup-devs.html"><strong aria-hidden="true">3.</strong> Rollup Devs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rollup-devs/build-a-module.html"><strong aria-hidden="true">3.1.</strong> Building a Module</a></li><li class="chapter-item expanded "><a href="rollup-devs/gas.html"><strong aria-hidden="true">3.2.</strong> Gas</a></li></ol></li><li class="chapter-item expanded "><a href="sdk-contributors.html"><strong aria-hidden="true">4.</strong> SDK Contributors</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sdk-contributors/transaction-lifecycle.html"><strong aria-hidden="true">4.1.</strong> Transaction Lifecyle</a></li><li class="chapter-item expanded "><a href="sdk-contributors/abstractions.html"><strong aria-hidden="true">4.2.</strong> Main Abstractions</a></li><li class="chapter-item expanded "><a href="forced-sequencer-registration.html"><strong aria-hidden="true">4.3.</strong> Forced Sequencer Registration</a></li><li class="chapter-item expanded "><a href="sdk-contributors/gas.html"><strong aria-hidden="true">4.4.</strong> Gas</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="sovereign-dark">Sovereign Dark</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Sovereign SDK Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="gas-specification"><a class="header" href="#gas-specification">Gas Specification</a></h1>
<p>This document contains a detailed specification of the way gas is handled within
Sovereign's SDK. We use <code>&lt;., .&gt;</code> to denote the scalar product of two
multidimensional quantities.</p>
<h2 id="definition"><a class="header" href="#definition">Definition</a></h2>
<p>Gas is an ubiquitous concept in the blockchain space. It is a measure of the
computational effort required to perform an operation as part of a transaction
execution context. This is used to prevent the network from getting spammed by
regulating the use of computational resources by each participant in the
network.</p>
<h2 id="high-level-overview"><a class="header" href="#high-level-overview">High level overview</a></h2>
<p>We have drawn a lot of inspiration from the
<a href="https://ethereum.org/en/developers/docs/gas/">Ethereum gas model</a> in our gas
mechanism design. Given that Ethereum's gas is well understood and widely used
in the crypto industry, we believe that this will help users onboard more easily
while providing strong security guarantees out-of-the box. We have deliberately
chosen to tweak some concepts that were ill-suited to the rollups built using
Sovereing's SDK. In particular, sorted decreasing order of importance:</p>
<ul>
<li>We are using multidimensional gas units and prices.</li>
<li>We plan to using a dynamic gas target. Otherwise, the rollups built with
Sovereign's SDK follow the <a href="https://eips.ethereum.org/EIPS/eip-1559">EIP-1559</a>
specification by default.</li>
<li>Rollup transactions specify a <code>max_fee</code>, <code>max_priority_fee_bips</code>, and
<em>optional gas limit</em> <code>gas_limit</code>. The semantics of these quantities roughtly
match their definition in the
<a href="https://eips.ethereum.org/EIPS/eip-1559">EIP-1559 specification</a>.</li>
<li>Transaction rewards are decomposed into <code>base_fee</code> and <code>priority_fee</code>. The
<code>base_fee</code> <em>is only partially burnt by default</em>, the remaining amount is used
<em>to reward provers/attesters</em>. The <code>priority_fee</code> is used to reward the <em>block
sequencers</em>.</li>
<li>We are charging gas for every storage access within the module system by
default.</li>
<li>Customers of the SDK will have access to wrappers that allow to charge gas for
hash computation and signature checks.</li>
</ul>
<h2 id="a-design-for-multidimensional-gas"><a class="header" href="#a-design-for-multidimensional-gas">A design for multidimensional gas</a></h2>
<p>Sovereign SDK's rollups use multidimensional gas units and prices. For example,
this allows developers to take into account the differences between native and
zero-knowledge computational costs for the same operation. Indeed:</p>
<ul>
<li>Hashing is orders of magnitude more expensive when performed inside a
zero-knowledge circuit. The cost of proving the correct computation of two
different Hash may also vary much more than the cost of computing the hash
itself (<code>Poseidon</code> or <code>MiMc</code> vs <code>Sha2</code>).</li>
<li>Accessing a storage cell for the first time is much more expensive in <code>zk</code>
mode than in <code>native</code> mode. But <em>hot</em> storage accesses are practically free in
zero-knowledge.</li>
</ul>
<p>In the Sovereign SDK, we currently meter consumption in two dimensions - compute
and memory.</p>
<p>We have chosen to follow the
<a href="https://ethresear.ch/t/multidimensional-eip-1559/11651">multi-dimensional EIP-1559</a>
design for the gas pricing adjustment formulas. In essence:</p>
<ul>
<li>We are performing the gas price updates for each dimension separately. In
other words, each dimension follows a separate uni-dimensional EIP-1559 gas
price adjustment formula.</li>
<li>The gas price adjustment formula uses a <code>gas_target</code> reference, which is a
uni-dimensional gas unit that is compared to the gas consumed <code>gas_used</code>. The
<code>gas_price</code> is then adjusted to regulate the gas throughtput to get as close
as possible to the <code>gas_target</code>. We have the following invariant:
<code>0 &lt;= gas_used_slot &lt;= 2 * gas_target</code>.</li>
<li><em>Contrarily to Ethereum</em>, we are planning to design a dynamic <code>gas_target</code>.
The value of the <code>gas_target</code> will vary slowly to follow the evolution of the
rollup metrics we have described above. That way, Sovereign rollups can
account for major technological improvements in computation (such as zk-proof
generation throughtput), or storage cost.</li>
<li>Every transaction has to specify a scalar <code>max_fee</code> which is the maximum
amount of <em>gas tokens</em> that can be used to execute a given transaction.
Similarly, users have to specify a <code>max_priority_fee_per_gas</code> expressed in
basis points which can be used to reward the transaction sequencer.</li>
<li>The final sequencer reward is:
<code>seq_reward = min(max_fee - &lt;base_fee, gas_price&gt;, max_priority_fee_per_gas * &lt;base_fee, gas_price&gt;)</code>.</li>
<li>Users can provide an optional <code>gas_limit</code> field which is a maximum amount of
gas to be used for the transaction. This quantity is converted to a
uni-dimensional <code>remaining_funds</code> quantity by taking the scalar product with
the current <code>gas_price</code>.</li>
<li>If users provide the <code>gas_limit</code>, the rollup checks that
<code>&lt;gas_limit, current_gas_price&gt; &lt;= max_fee</code> (ie, the scalar product with the
current <code>gas_price</code>). If the check fails, the associated transaction is not
executed and the rollup raises a
<code>ReserveGasErrorReason::CurrentGasPriceTooHigh</code> error.</li>
</ul>
<h2 id="charging-gas-for-state-accesses"><a class="header" href="#charging-gas-for-state-accesses">Charging gas for state accesses.</a></h2>
<p>State accessors such as the <code>WorkingSet</code> or the <code>PreExecWorkingSet</code> charge some
gas whenever state is modified. If these accessors run out of gas, they return a
<code>StateAccessorError</code> and the execution gets reverted (or the sequencer is
penalized). Some state accessors - like <code>StateCheckpoint</code>, the <code>TxScratchpad</code> or
the <code>ApiStateAccessor</code> - don't charge for gas for state accesses. In that case,
the access methods return a <code>Result&lt;T, Infallible&gt;</code> type which can be unwrapped
safely using <code>unwrap_infallible</code>.</p>
<p>For now, we are enforcing simple cached access patterns - we are refunding some
gas if the value that is accessed/modified is <em>hot</em> (ie has been already
accessed and is cached).</p>
<h2 id="gas-rewards"><a class="header" href="#gas-rewards">Gas rewards.</a></h2>
<p>The gas consumed during transaction execution is used to reward both
provers/attesters and block sequencers. The <code>base_fee</code>, ie the total amount of
gas consumed by the transaction execution is partially burnt (the amount to burn
is specified by the <code>PERCENT_BASE_FEE_TO_BURN</code> constant), and the remaining
portion is locked in a reward pool to be redeemed by provers/attesters. The
<code>priority_fee</code> is also partially burnt and used to reward block sequencers.</p>
<h2 id="additional-data-structures-that-can-be-used-to-charge-gas"><a class="header" href="#additional-data-structures-that-can-be-used-to-charge-gas">Additional data structures that can be used to charge gas.</a></h2>
<p>We have a couple of additional data structures that can be used to charge gas.
These are:</p>
<ul>
<li><code>MeteredHasher</code>: a wrapper structure that can be used to charge gas for hash
computation.</li>
<li><code>MeteredSignature</code>: a wrapper structure that can be used to charge gas for
signature checks.</li>
<li><code>MeteredBorshDeserialize</code>: a supertrait that can be used to charge gas for
structures implementing <code>BorshDeserialize</code>.</li>
</ul>
<h2 id="structure-of-the-implementation"><a class="header" href="#structure-of-the-implementation">Structure of the implementation</a></h2>
<p>The core of the gas implementation is located within the <code>sov-modules-api</code> crate
in the following modules/files:</p>
<ul>
<li><code>module-system/sov-modules-api/src/common/gas.rs</code>: contains the implementation
of the <code>Gas</code> and <code>GasMeter</code> traits. These are the core interfaces that are
consumed by the API. The <code>Gas</code> trait defines the way users can interact with
multidimensional gas units. The <code>GasMeter</code> is the interface implemented by
every data structure that contains or consumes gas (such as the <code>WorkingSet</code>
which contains a <code>TxGasMeter</code>, or the <code>PreExecWorkingSet</code> that may contain a
<code>SequencerStakeMeter</code>).</li>
<li><code>module-system/sov-modules-api/src/common/hash.rs</code>: contains the
implementation of the <code>MeteredHasher</code> which is a wrapper structure that can be
used to charge gas for hash computation.</li>
<li><code>module-system/sov-modules-api/src/transaction.rs</code>: contains the
representation of the transaction type that is used within the SDK. These
structures contain the <code>max_fee</code>, <code>max_priority_fee_bips</code> and <code>gas_limit</code>
fields that represent the maximum amount of gas tokens to use for the
transaction, the maximum priority fee to pay the sequencer (in basis points),
and an optionnal multidimensional gas limit (ie the maximum amount of gas to
be consumed for this transaction).</li>
</ul>
<p>Outside of the <code>sov-modules-api</code>, within the module system:</p>
<ul>
<li><code>module-system/module-implementations/sov-chain-state/src/gas.rs</code>:
<code>compute_base_fee_per_gas</code> contains the implementation of the gas price update
which follows our modified version of the <code>EIP-1559</code>. The gas price is updated
within the <code>ChainState</code>'s module lifecycle hooks
(<code>ChainState::begin_slot_hook</code> updates the gas price,
<code>ChainState::end_slot_hook</code> updates the gas consumed by the transaction).</li>
<li><code>module-system/module-implementations/sov-sequencer-registry/src/capabilities.rs</code>:
contains the implementationn of the <code>SequencerStakeMeter</code> which is the data
structure used to meter the sequencer stake before the transaction's execution
starts.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../forced-sequencer-registration.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../forced-sequencer-registration.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
